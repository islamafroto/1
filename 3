# BACKEND PROJECT STRUCTURE

## Recommended Folder Structure

```
gym-backend/
├── src/
│   ├── config/
│   │   ├── database.js          # Database connection configuration
│   │   ├── jwt.js               # JWT configuration
│   │   └── twilio.js            # Twilio SMS configuration
│   │
│   ├── middleware/
│   │   ├── auth.js              # Authentication middleware
│   │   ├── authorize.js         # Authorization middleware (role-based)
│   │   ├── validate.js          # Request validation middleware
│   │   ├── errorHandler.js      # Global error handler
│   │   └── rateLimiter.js       # Rate limiting middleware
│   │
│   ├── models/
│   │   ├── User.js              # User model
│   │   ├── Membership.js        # Membership model
│   │   ├── Payment.js           # Payment model
│   │   ├── Class.js             # Class model
│   │   ├── ClassInstance.js     # Class instance model
│   │   ├── Booking.js           # Booking model
│   │   ├── Notification.js      # Notification model
│   │   └── Setting.js           # Setting model
│   │
│   ├── controllers/
│   │   ├── authController.js    # Authentication logic
│   │   ├── userController.js    # User CRUD operations
│   │   ├── membershipController.js
│   │   ├── paymentController.js
│   │   ├── classController.js
│   │   ├── classInstanceController.js
│   │   ├── bookingController.js
│   │   ├── notificationController.js
│   │   ├── dashboardController.js
│   │   ├── settingsController.js
│   │   └── reportController.js
│   │
│   ├── routes/
│   │   ├── index.js             # Main router
│   │   ├── auth.routes.js
│   │   ├── user.routes.js
│   │   ├── membership.routes.js
│   │   ├── payment.routes.js
│   │   ├── class.routes.js
│   │   ├── classInstance.routes.js
│   │   ├── booking.routes.js
│   │   ├── notification.routes.js
│   │   ├── dashboard.routes.js
│   │   ├── settings.routes.js
│   │   └── report.routes.js
│   │
│   ├── services/
│   │   ├── authService.js       # Authentication business logic
│   │   ├── membershipService.js # Membership business logic
│   │   ├── bookingService.js    # Booking business logic
│   │   ├── notificationService.js # Notification logic
│   │   ├── smsService.js        # SMS sending via Twilio
│   │   ├── emailService.js      # Email service (future)
│   │   └── reportService.js     # Report generation
│   │
│   ├── jobs/
│   │   ├── expirationChecker.js # Check membership expirations
│   │   ├── notificationSender.js # Send scheduled notifications
│   │   └── instanceGenerator.js  # Generate class instances
│   │
│   ├── utils/
│   │   ├── asyncHandler.js      # Async error handling wrapper
│   │   ├── logger.js            # Logging utility
│   │   ├── dateHelper.js        # Date formatting and calculations
│   │   ├── validators.js        # Custom validation functions
│   │   └── ApiResponse.js       # Standardized API response format
│   │
│   ├── validators/
│   │   ├── authValidator.js
│   │   ├── userValidator.js
│   │   ├── membershipValidator.js
│   │   ├── bookingValidator.js
│   │   └── classValidator.js
│   │
│   └── app.js                   # Express app setup
│
├── tests/
│   ├── unit/
│   │   ├── services/
│   │   └── models/
│   └── integration/
│       └── api/
│
├── uploads/                     # Uploaded files (profile photos)
│   └── profiles/
│
├── logs/                        # Application logs
│   ├── error.log
│   └── combined.log
│
├── .env                         # Environment variables
├── .env.example                 # Example environment file
├── .gitignore
├── package.json
├── server.js                    # Entry point
└── README.md
```

---

## File Templates

### 1. server.js (Entry Point)
```javascript
require('dotenv').config();
const app = require('./src/app');
const { connectDatabase } = require('./src/config/database');
const logger = require('./src/utils/logger');

// Cron Jobs
const expirationChecker = require('./src/jobs/expirationChecker');
const instanceGenerator = require('./src/jobs/instanceGenerator');

const PORT = process.env.PORT || 5000;

// Connect to database
connectDatabase()
  .then(() => {
    logger.info('Database connected successfully');
    
    // Start server
    app.listen(PORT, () => {
      logger.info(`Server running on port ${PORT}`);
      logger.info(`Environment: ${process.env.NODE_ENV}`);
    });

    // Start cron jobs
    expirationChecker.start();
    instanceGenerator.start();
  })
  .catch((error) => {
    logger.error('Failed to connect to database:', error);
    process.exit(1);
  });

// Handle unhandled promise rejections
process.on('unhandledRejection', (err) => {
  logger.error('Unhandled Rejection:', err);
  process.exit(1);
});
```

---

### 2. src/app.js
```javascript
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const path = require('path');

const routes = require('./routes');
const errorHandler = require('./middleware/errorHandler');
const logger = require('./utils/logger');

const app = express();

// Security middleware
app.use(helmet());

// CORS configuration
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true
}));

// Body parser
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// HTTP request logger
app.use(morgan('combined', {
  stream: { write: (message) => logger.info(message.trim()) }
}));

// Static files
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// API routes
app.use('/api', routes);

// 404 handler
app.use((req, res) => {
  res.status(404).json({
    success: false,
    error: 'Route not found'
  });
});

// Global error handler
app.use(errorHandler);

module.exports = app;
```

---

### 3. src/config/database.js
```javascript
const mysql = require('mysql2/promise');
const logger = require('../utils/logger');

let pool;

const connectDatabase = async () => {
  try {
    pool = mysql.createPool({
      host: process.env.DB_HOST || 'localhost',
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '',
      database: process.env.DB_NAME || 'gym_management',
      waitForConnections: true,
      connectionLimit: 10,
      queueLimit: 0,
      enableKeepAlive: true,
      keepAliveInitialDelay: 0
    });

    // Test connection
    const connection = await pool.getConnection();
    logger.info('MySQL connection established');
    connection.release();

    return pool;
  } catch (error) {
    logger.error('Database connection failed:', error);
    throw error;
  }
};

const getPool = () => {
  if (!pool) {
    throw new Error('Database pool not initialized');
  }
  return pool;
};

module.exports = { connectDatabase, getPool };
```

---

### 4. src/config/jwt.js
```javascript
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-this';
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d';

const generateToken = (payload) => {
  return jwt.sign(payload, JWT_SECRET, {
    expiresIn: JWT_EXPIRES_IN
  });
};

const verifyToken = (token) => {
  try {
    return jwt.verify(token, JWT_SECRET);
  } catch (error) {
    throw new Error('Invalid or expired token');
  }
};

module.exports = { generateToken, verifyToken };
```

---

### 5. src/middleware/auth.js
```javascript
const { verifyToken } = require('../config/jwt');
const ApiResponse = require('../utils/ApiResponse');

const authenticate = async (req, res, next) => {
  try {
    // Get token from header
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return ApiResponse.unauthorized(res, 'No token provided');
    }

    const token = authHeader.substring(7); // Remove 'Bearer '

    // Verify token
    const decoded = verifyToken(token);
    
    // Attach user info to request
    req.user = {
      id: decoded.id,
      role: decoded.role
    };

    next();
  } catch (error) {
    return ApiResponse.unauthorized(res, 'Invalid or expired token');
  }
};

module.exports = authenticate;
```

---

### 6. src/middleware/authorize.js
```javascript
const ApiResponse = require('../utils/ApiResponse');

const authorize = (...roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return ApiResponse.unauthorized(res, 'Not authenticated');
    }

    if (!roles.includes(req.user.role)) {
      return ApiResponse.forbidden(res, 'Insufficient permissions');
    }

    next();
  };
};

module.exports = authorize;
```

---

### 7. src/middleware/errorHandler.js
```javascript
const logger = require('../utils/logger');
const ApiResponse = require('../utils/ApiResponse');

const errorHandler = (err, req, res, next) => {
  // Log error
  logger.error(`Error: ${err.message}`, {
    stack: err.stack,
    path: req.path,
    method: req.method
  });

  // Default error
  let statusCode = err.statusCode || 500;
  let message = err.message || 'Internal Server Error';

  // Handle specific error types
  if (err.code === 'ER_DUP_ENTRY') {
    statusCode = 409;
    message = 'Duplicate entry. Resource already exists.';
  }

  if (err.name === 'ValidationError') {
    statusCode = 422;
  }

  // Send error response
  res.status(statusCode).json({
    success: false,
    error: message,
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
};

module.exports = errorHandler;
```

---

### 8. src/utils/ApiResponse.js
```javascript
class ApiResponse {
  static success(res, data, message = 'Success', statusCode = 200) {
    return res.status(statusCode).json({
      success: true,
      data,
      message
    });
  }

  static created(res, data, message = 'Created successfully') {
    return res.status(201).json({
      success: true,
      data,
      message
    });
  }

  static error(res, message, statusCode = 500) {
    return res.status(statusCode).json({
      success: false,
      error: message
    });
  }

  static badRequest(res, message = 'Bad request') {
    return this.error(res, message, 400);
  }

  static unauthorized(res, message = 'Unauthorized') {
    return this.error(res, message, 401);
  }

  static forbidden(res, message = 'Forbidden') {
    return this.error(res, message, 403);
  }

  static notFound(res, message = 'Resource not found') {
    return this.error(res, message, 404);
  }

  static conflict(res, message = 'Conflict') {
    return this.error(res, message, 409);
  }

  static validationError(res, errors) {
    return res.status(422).json({
      success: false,
      error: 'Validation failed',
      details: errors
    });
  }
}

module.exports = ApiResponse;
```

---

### 9. src/utils/asyncHandler.js
```javascript
// Wrapper for async route handlers to catch errors
const asyncHandler = (fn) => {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

module.exports = asyncHandler;
```

---

### 10. src/controllers/authController.js (Example)
```javascript
const bcrypt = require('bcrypt');
const { getPool } = require('../config/database');
const { generateToken } = require('../config/jwt');
const ApiResponse = require('../utils/ApiResponse');
const asyncHandler = require('../utils/asyncHandler');

// @desc    Login user
// @route   POST /api/auth/login
// @access  Public
const login = asyncHandler(async (req, res) => {
  const { phone, password } = req.body;

  // Validation
  if (!phone || !password) {
    return ApiResponse.badRequest(res, 'Phone and password are required');
  }

  const pool = getPool();
  
  // Find user
  const [users] = await pool.query(
    'SELECT * FROM users WHERE phone = ? AND status = "active"',
    [phone]
  );

  if (users.length === 0) {
    return ApiResponse.unauthorized(res, 'Invalid phone number or password');
  }

  const user = users[0];

  // Check password
  const isPasswordValid = await bcrypt.compare(password, user.password_hash);
  
  if (!isPasswordValid) {
    return ApiResponse.unauthorized(res, 'Invalid phone number or password');
  }

  // Generate token
  const token = generateToken({
    id: user.id,
    role: user.role
  });

  // Return response
  return ApiResponse.success(res, {
    token,
    user: {
      id: user.id,
      name: user.name,
      phone: user.phone,
      email: user.email,
      role: user.role,
      profile_photo: user.profile_photo
    }
  });
});

// @desc    Logout user
// @route   POST /api/auth/logout
// @access  Private
const logout = asyncHandler(async (req, res) => {
  // In JWT, logout is handled client-side by removing token
  return ApiResponse.success(res, null, 'Logged out successfully');
});

module.exports = {
  login,
  logout
};
```

---

### 11. src/routes/auth.routes.js (Example)
```javascript
const express = require('express');
const { login, logout } = require('../controllers/authController');
const authenticate = require('../middleware/auth');

const router = express.Router();

router.post('/login', login);
router.post('/logout', authenticate, logout);

module.exports = router;
```

---

### 12. src/routes/index.js
```javascript
const express = require('express');
const authRoutes = require('./auth.routes');
const userRoutes = require('./user.routes');
const membershipRoutes = require('./membership.routes');
const classRoutes = require('./class.routes');
const bookingRoutes = require('./booking.routes');
const dashboardRoutes = require('./dashboard.routes');
const settingsRoutes = require('./settings.routes');
const reportRoutes = require('./report.routes');

const router = express.Router();

router.use('/auth', authRoutes);
router.use('/users', userRoutes);
router.use('/memberships', membershipRoutes);
router.use('/classes', classRoutes);
router.use('/bookings', bookingRoutes);
router.use('/dashboard', dashboardRoutes);
router.use('/settings', settingsRoutes);
router.use('/reports', reportRoutes);

module.exports = router;
```

---

### 13. package.json
```json
{
  "name": "gym-backend",
  "version": "1.0.0",
  "description": "Gym Management System Backend API",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "jest --coverage",
    "test:watch": "jest --watch"
  },
  "keywords": ["gym", "management", "api"],
  "author": "Your Name",
  "license": "MIT",
  "dependencies": {
    "express": "^4.18.2",
    "mysql2": "^3.6.5",
    "bcrypt": "^5.1.1",
    "jsonwebtoken": "^9.0.2",
    "dotenv": "^16.3.1",
    "cors": "^2.8.5",
    "helmet": "^7.1.0",
    "morgan": "^1.10.0",
    "joi": "^17.11.0",
    "multer": "^1.4.5-lts.1",
    "node-cron": "^3.0.3",
    "twilio": "^4.19.0",
    "winston": "^3.11.0",
    "express-rate-limit": "^7.1.5"
  },
  "devDependencies": {
    "nodemon": "^3.0.2",
    "jest": "^29.7.0",
    "supertest": "^6.3.3"
  }
}
```

---

### 14. .env.example
```env
# Server Configuration
NODE_ENV=development
PORT=5000

# Database Configuration
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=gym_management

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=7d

# Twilio Configuration
TWILIO_ACCOUNT_SID=your_twilio_account_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_PHONE_NUMBER=+1234567890

# Frontend URL (for CORS)
FRONTEND_URL=http://localhost:3000

# File Upload
MAX_FILE_SIZE=5242880
UPLOAD_PATH=./uploads

# Logging
LOG_LEVEL=info
```

---

## Installation & Setup Commands

```bash
# Initialize project
mkdir gym-backend
cd gym-backend
npm init -y

# Install dependencies
npm install express mysql2 bcrypt jsonwebtoken dotenv cors helmet morgan joi multer node-cron twilio winston express-rate-limit

# Install dev dependencies
npm install --save-dev nodemon jest supertest

# Create folder structure
mkdir -p src/{config,middleware,models,controllers,routes,services,jobs,utils,validators}
mkdir -p tests/{unit,integration}
mkdir -p uploads/profiles
mkdir logs

# Copy .env.example to .env
cp .env.example .env

# Initialize database
mysql -u root -p < database/schema.sql
```

---

## Development Workflow

1. **Start Development Server:**
```bash
npm run dev
```

2. **Run Tests:**
```bash
npm test
```

3. **Check Logs:**
```bash
tail -f logs/combined.log
```

---

## Next Steps
1. Implement all controllers following the authController example
2. Create validators for each endpoint
3. Implement cron jobs for automated tasks
4. Write unit tests for business logic
5. Write integration tests for API endpoints
6. Set up CI/CD pipeline

---

**End of Backend Structure Guide**
